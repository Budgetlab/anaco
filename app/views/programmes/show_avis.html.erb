<%= turbo_frame_tag :show do %>
  <div class="fr-h2">Liste des BOP</div>
  <div class="fr-accordions-group fr-mb-4w">
    <% @bops.each do |bop| %>
      <% avis_bop = get_avis_for_bop(['début de gestion', 'CRG1', 'CRG2'], bop, @avis) %>
      <section class="fr-accordion">
        <h3 class="fr-accordion__title">
          <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-<%= bop.id %>">
            BOP n°<%= bop.code %>
            <% if bop.dotation == "aucune" %>
              <p class="fr-badge fr-badge--no-icon fr-ml-2w">BOP inactif</p>
            <% else %>
              <% avis_bop.each do |avis| %>
                <% unless avis.nil? %>
                  <p class="<%= badge_class_for_statut(avis.statut) %> fr-ml-2w"><%= avis.phase %></p>
                  <% if avis.phase == "début de gestion" && avis.is_crg1 == false %>
                    <p class="fr-badge fr-badge--no-icon fr-ml-2w">PAS DE CRG1</p>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          </button>
        </h3>
        <div class="fr-collapse" id="accordion-<%= bop.id %>">
          <p class="fr-tag fr-mb-2w"><%= bop.user.nom %></p>
          <ul class="fr-btns-group fr-btns-group--inline">
            <li>
              <% avis_bop.each_with_index do |avis, index| %>
                <% if avis.nil? %>
                  <% if index == 0 || index == 2 %>
                    <button class="fr-btn" disabled><%= index == 0 ? 'Avis début de gestion' : 'Note CRG2' %></button>
                  <% elsif index == 1 %>
                    <% if avis_bop.first.nil? || avis_bop.first.is_crg1? %>
                      <button class="fr-btn" disabled>Note CRG1</button>
                    <% end %>
                  <% end %>
                <% else %>
                  <%= link_to open_modal_path(id: avis.id), class: "fr-btn", "data-fr-opened": false, "aria-controls": "modal-1", data: { "turbo_method": :post, turbo_frame: "_top" } do %>
                    <%= index == 0 ? 'Avis' : 'Note' %> <%= avis.phase %>
                  <% end %>
                <% end %>
              <% end %>
            </li>
          </ul>
        </div>
      </section>
    <% end %>
  </div>

  <dialog id="modal-1" class="fr-modal" aria-labelledby="modal-1-title">
    <div id="debut">
      <%= render partial: 'avis/dialog_debut', locals: { avis: nil } %>
    </div>
  </dialog>
<% end %>

