<%= turbo_frame_tag :show, target: '_top' do %>
  <div class="fr-h2">Nous sommes en phase de <%= @phase %></div>
  <% phases = display_phases(@annee_a_afficher, @annee, @date_crg1, @date_crg2) %>

  <h3 class="fr-mt-3w">Données budgétaires</h3>

  <div class="fr-tabs fr-mb-4w">
    <ul class="fr-tabs__list" role="tablist" aria-label="Données budgétaires">
      <% phases.each_with_index do |phase, index| %>
        <li role="presentation">
          <button id="tabpanel-<%= index %>" class="fr-tabs__tab" tabindex="<%= index == 0 ? "0" : "-1" %>" role="tab" aria-selected="<%= index == 0 %>" aria-controls="tabpanel-<%= index %>-panel"><%= phase %></button>
        </li>
      <% end %>
    </ul>
    <% phases.each_with_index do |phase, index| %>
      <div id="tabpanel-<%= index %>-panel" class="fr-tabs__panel <%= index == 0 ? 'fr-tabs__panel--selected' : '' %>" role="tabpanel" aria-labelledby="tabpanel-<%= index %>" tabindex="0">

        <div class="fr-mt-2w">
          <%= render partial: "avis/rappel_chiffres", locals: { avis: sum_chiffres_avis(@avis, phase)[0..3], titre: 'alloué', class_active: 'fr-card--green' } %>
        </div>
        <%= render partial: "avis/rappel_chiffres", locals: { avis: sum_chiffres_avis(@avis, phase)[4..7], titre: 'prév.', class_active: 'fr-card--orange' } %>
        <div class="fr-mt-2w">
          <%= render partial: "avis/rappel_chiffres", locals: { avis: sum_chiffres_avis(@avis, phase)[0..3] - sum_chiffres_avis(@avis, phase)[4..7], titre: 'Ecart', class_active: 'fr-card--blue' } %>
        </div>
      </div>
    <% end %>
  </div>




  <div class="fr-h2">Restitutions</div>
  <div class="fr-h2">Liste des BOP</div>
  <div class="fr-accordions-group fr-mb-4w">
    <% @bops.each do |bop| %>
      <% avis_bop = get_avis_for_bop(['début de gestion', 'CRG1', 'CRG2'], bop, @avis) %>
      <section class="fr-accordion">
        <h3 class="fr-accordion__title">
          <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-<%= bop.id %>">
            BOP n°<%= bop.code %>
            <% if bop.dotation == "aucune" %>
              <p class="fr-badge fr-badge--no-icon fr-ml-2w">BOP inactif</p>
            <% else %>
              <% avis_bop.each do |avis| %>
                <% unless avis.nil? %>
                  <p class="<%= badge_class_for_statut(avis.statut) %> fr-ml-2w"><%= avis.phase %></p>
                  <% if avis.phase == "début de gestion" && avis.is_crg1 == false %>
                    <p class="fr-badge fr-badge--no-icon fr-ml-2w">PAS DE CRG1</p>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          </button>
        </h3>
        <div class="fr-collapse" id="accordion-<%= bop.id %>">
          <p class="fr-tag fr-mb-2w"><%= bop.user.nom %></p>
          <ul class="fr-btns-group fr-btns-group--inline">
            <li>
              <% avis_bop.each_with_index do |avis, index| %>
                <% if avis.nil? %>
                  <% if index == 0 || index == 2 %>
                    <button class="fr-btn" disabled><%= index == 0 ? 'Avis début de gestion' : 'Note CRG2' %></button>
                  <% elsif index == 1 %>
                    <% if avis_bop.first.nil? || avis_bop.first.is_crg1? %>
                      <button class="fr-btn" disabled>Note CRG1</button>
                    <% end %>
                  <% end %>
                <% else %>
                  <%= link_to open_modal_path(id: avis.id), class: "fr-btn", "data-fr-opened": false, "aria-controls": "modal-1", data: { "turbo_method": :post, turbo_frame: "_top" } do %>
                    <%= index == 0 ? 'Avis' : 'Note' %> <%= avis.phase %>
                  <% end %>
                <% end %>
              <% end %>
            </li>
          </ul>
        </div>
      </section>
    <% end %>
  </div>

  <dialog id="modal-1" class="fr-modal" aria-labelledby="modal-1-title">
    <div id="debut">
      <%= render partial: 'avis/dialog_debut', locals: { avis: nil } %>
    </div>
  </dialog>
<% end %>

