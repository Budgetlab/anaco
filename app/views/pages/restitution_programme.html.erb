<% content_for :title do %>Restitutions du programme | Anaco <% end %>
<div class="fr-container" data-controller="highcharts" data-highcharts-avis="<%= @avis_repartition %>" data-highcharts-avisdate="<%= @avis_date_repartition %>"  data-highcharts-notesbar="<%= @notes_bar %>">
  <nav role="navigation" class="fr-breadcrumb" aria-label="vous êtes ici :">
    <button class="fr-breadcrumb__button " aria-expanded="false" aria-controls="breadcrumb-1" title="voir le fil d'ariane">Voir le fil d’Ariane</button>
    <div class="fr-collapse" id="breadcrumb-1">
      <ol class="fr-breadcrumb__list">
        <li>
          <%= link_to root_path, class:"fr-breadcrumb__link" do %> Accueil <%end %>
        </li>
        <li>
          <%= link_to restitutions_path, class:"fr-breadcrumb__link" do %> Restitutions <%end %>
        </li>
        <li>
          <a class="fr-breadcrumb__link" aria-current="page">Programme n°<%= @numero%></a>
        </li>
      </ol>
    </div>
  </nav>

  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12 fr-col-lg-12">
      <h1 class="fr-mb-2w title-btn"><div>Restitution du programme n°<%= @numero %></div> <nav role="navigation" class="fr-pagination" aria-label="Pagination">
        <ul class="fr-pagination__list">
          <li>
            <%= link_to specific_restitutions_path(programme: @numero, date: 2023), class: "fr-pagination__link", aria: (@annee_a_afficher == 2023 ? { current: 'page' } : {}) do %>
              2023
            <%end %>
          </li>
          <li>
            <%= link_to specific_restitutions_path(programme: @numero, date: 2024), class: "fr-pagination__link",aria: (@annee_a_afficher == 2024 ? { current: 'page' } : {}) do %>
              2024
            <%end %>
          </li>
        </ul>
      </nav></h1>
      <p class="fr-tag">Ministère <%= @ministere %></p>
      <p class="fr-card__detail fr-icon-arrow-right-line fr-mt-1w"><%= @bops_count_all %> BOP (<%= pluralize(@bops_count_all-@bops_actifs_count,'BOP inactif')  %>)</p>
    </div>
  </div>

  <% if @annee_a_afficher == @annee %><h2 class="fr-mt-3w">Nous sommes en phase de <%= @phase %> <%= @annee %></h2><% end %>

  <% if current_user.statut != "CBR" %>
    <h3 class="fr-mt-3w">Ressources allouées</h3>
    <%= render partial: "pages/restitution_chiffres", locals: {titre: "Ressources", phase: @phase, hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
    <% if Date.today >= @date_crg2 || @annee_a_afficher < @annee %>
      <%= render partial: "pages/restitution_chiffres", locals: {titre: "Ressources", phase: 'CRG1', hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
    <% end %>
    <% if Date.today >= @date_crg1 || @annee_a_afficher < @annee %>
      <%= render partial: "pages/restitution_chiffres", locals: {titre: "Ressources", phase: 'début de gestion', hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
    <% end %>
    <%= render partial: "pages/restitution_chiffres", locals: {titre: "Ressources", phase: 'execution', hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
    <h3 class="fr-mt-3w">Prévision d’exécution</h3>
    <%= render partial: "pages/restitution_chiffres", locals: {titre: "Prévision", phase: @phase, hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
    <% if Date.today >= @date_crg2 || @annee_a_afficher < @annee %>
      <%= render partial: "pages/restitution_chiffres", locals: {titre: "Prévision", phase: 'CRG1', hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
    <% end %>
    <% if Date.today >= @date_crg1 || @annee_a_afficher < @annee %>
      <%= render partial: "pages/restitution_chiffres", locals: {titre: "Prévision", phase: 'début de gestion', hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
    <% end %>
    <%= render partial: "pages/restitution_chiffres", locals: {titre: "Prévision", phase: 'execution', hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
    <h3 class="fr-mt-3w">Écarts ressources allouées/prévision d’exécution</h3>
    <%= render partial: "pages/restitution_chiffres", locals: {titre: "Écart", phase: @phase, hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
    <%= render partial: "pages/restitution_cnrep", locals: {phase: @phase, credit: @credit_hash} %>
    <% if Date.today >= @date_crg2 || @annee_a_afficher < @annee %>
      <%= render partial: "pages/restitution_chiffres", locals: {titre: "Écart", phase: "CRG1", hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
      <%= render partial: "pages/restitution_cnrep", locals: {phase: "CRG1", credit: @credit_hash} %>
    <% end %>
    <% if Date.today >= @date_crg1 || @annee_a_afficher < @annee %>
      <%= render partial: "pages/restitution_chiffres", locals: {titre: "Écart", phase: "début de gestion", hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
      <%= render partial: "pages/restitution_cnrep", locals: {phase: "début de gestion", credit: @credit_hash} %>
    <% end %>

    <%= render partial: "pages/restitution_chiffres", locals: {titre: "Écart", phase: "execution", hash_donnees_phase: @hash_donnees_phase, hash_donnees_phase_controleur: @hash_donnees_phase_controleur} %>
  <% end %>

  <h2 class="fr-mb-2w fr-mt-4w">Statistiques sur les <%= @bops_actifs_count %> BOP actifs du programme</h2>
  <div class="fr-grid-row fr-grid-row--gutters" >
    <div class="fr-col-12 fr-col-lg-4">
      <div data-highcharts-target="canvasAvisDate"></div>
    </div>
    <div class="fr-col-12 fr-col-lg-4">
      <div data-highcharts-target="canvasAvis"></div>
    </div>
    <div class="fr-col-12 fr-col-lg-4">
        <div data-highcharts-target="canvasNotesBar"></div>
    </div>
  </div>

  <div class="fr-grid-row fr-grid-row--gutters fr-mt-4w">
    <div class="fr-col-12 fr-col-lg-12">
      <h2 class="fr-mb-2w">Liste des <%= @bops_count_all %> BOP du programme</h2>
    </div>
  </div>
  <div class="fr-download">
    <h3>
      <%= link_to specific_restitutions_path(programme: @numero, date: @annee_a_afficher, format: :xlsx), class: "fr-download__link" do %> Télécharger l'ensemble des avis <%= @annee_a_afficher %> sur ce programme
        <span class="fr-download__detail">Format .xlsx</span>
      <%end %>
    </h3>
  </div>
  <div class="fr-grid-row fr-grid-row--gutters fr-mb-2w" data-controller="filter">
    <div class="fr-col-12 fr-col-lg-12">
      <%= form_with(url: filter_restitution_path, method: :post, data: {'filter-target': "form", action: "change->filter#submitFilter"}) do |f|%>
        <%= f.hidden_field :programme, value: @numero %>
        <%= f.hidden_field :date, value: @annee_a_afficher %>
        <ul class="fr-btns-group fr-btns-group--inline-sm">
          <li>
            <div class="fr-translate fr-nav">
              <div>
                <button class="fr-translate__btn fr-btn fr-btn--tertiary" aria-controls="translate-1294" aria-expanded="false" title="Sélectionner un contrôleur" data-action="click->filter#Dropdown">
                  Filtrer par contrôleur
                </button>
                <div class="fr-collapse fr-translate__menu fr-menu" id="translate-1294">
                  <ul class="fr-menu__list">
                    <li><fieldset class="fr-fieldset fr-mt-1w " id="checkboxes-small" aria-labelledby="checkboxes-small-legend checkboxes-small-messages">
                      <legend class="fr-fieldset__legend--regular fr-fieldset__legend fr-mb-0">
                        Sélectionner un ou plusieurs contrôleurs
                      </legend>
                      <div class="fr-fieldset__element">
                        <% @bops_user_id.values.sort.each_with_index do |name,i| %>
                        <div class="fr-checkbox-group fr-checkbox-group--sm fr-mb-1w">
                          <%= f.check_box "users[]", {id: "checkboxes-#{i}"}, @bops_user_id.key(name)%>
                          <label class="fr-label" for="checkboxes-<%=i %>"><%= name %></label>
                          <div class="fr-messages-group" id="checkboxes-small-<%=i %>-messages" aria-live="assertive"></div>
                        </div>
                        <%end %>
                      </div>
                      <div class="fr-messages-group" id="checkboxes-small-messages" aria-live="assertive"></div>
                    </fieldset></li>
                  </ul>
                </div>
              </div>
            </div>
          </li>
          <li>
            <div class="fr-translate fr-nav">
              <div>
                <button class="fr-translate__btn fr-btn fr-btn--tertiary" aria-controls="translate-1295" aria-expanded="false" title="Sélectionner un ou plusieurs types d'avis" data-action="click->filter#Dropdown">
                  Filtrer par type d'avis
                </button>
                <div class="fr-collapse fr-translate__menu fr-menu" id="translate-1295">
                  <ul class="fr-menu__list">
                    <li><fieldset class="fr-fieldset fr-mt-1w " id="checkboxes-avis" aria-labelledby="checkboxes-avis-legend checkboxes-avis-messages">
                      <legend class="fr-fieldset__legend--regular fr-fieldset__legend fr-mb-0">
                        Sélectionner un ou plusieurs types d'avis
                      </legend>
                      <div class="fr-fieldset__element">
                        <% ["Favorable","Favorable avec réserve","Défavorable"].each_with_index do |etat,i| %>
                          <div class="fr-checkbox-group fr-checkbox-group--sm fr-mb-1w">
                            <%= f.check_box "avis[]", {id: "checkboxes-avis-#{i}"}, etat%>
                            <label class="fr-label" for="checkboxes-avis-<%=i %>"><%= etat %></label>
                            <div class="fr-messages-group" id="checkboxes-avis-<%=i %>-messages" aria-live="assertive"></div>
                          </div>
                        <%end %>
                      </div>
                      <div class="fr-messages-group" id="checkboxes-avis-messages" aria-live="assertive"></div>
                    </fieldset></li>
                  </ul>
                </div>
              </div>
            </div>
          </li>
        </ul>
      <% end  %>
    </div>
  </div>

  <div id="liste_bops">
    <%= render partial: 'pages/restitution_liste_bop', locals: {bops: @bops} %>
  </div>
</div>