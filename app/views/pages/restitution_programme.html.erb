<div class="fr-container" data-controller="highcharts" data-highcharts-avis="<%=@avis %>" data-highcharts-avisdate="<%=@avis_date %>"  data-highcharts-notesbar="<%= @notesbar %>">
  <nav role="navigation" class="fr-breadcrumb" aria-label="vous êtes ici :">
    <button class="fr-breadcrumb__button " aria-expanded="false" aria-controls="breadcrumb-1" title="voir le fil d'ariane">Voir le fil d’Ariane</button>
    <div class="fr-collapse" id="breadcrumb-1">
      <ol class="fr-breadcrumb__list">
        <li>
          <%= link_to root_path, class:"fr-breadcrumb__link" do %> Accueil <%end %>
        </li>
        <li>
          <%= link_to restitutions_path, class:"fr-breadcrumb__link" do %> Restitutions <%end %>
        </li>
        <li>
          <a class="fr-breadcrumb__link" aria-current="page">Programme n°<%= @numero%></a>
        </li>
      </ol>
    </div>
  </nav>
  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12 fr-col-lg-12">
      <h1 class="fr-mb-2w">Restitution du programme n°<%= @numero %></h1>
      <p class="fr-tag">Ministère <%=@ministere %></p>
      <p class="fr-card__detail fr-icon-arrow-right-line fr-mt-1w"><%= @bops_count %> BOP</p>
    </div>
  </div>
  <h2 class="fr-mt-3w">Nous sommes en phase de <%= @phase %></h2>
  <% if current_user.statut != "CBR" %>
    <h3 class="fr-mt-3w">Ressources allouées initiales</h3>
    <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle" >
      <div class="fr-col-12 fr-col-lg-1">
        <%= @phase %>
      </div>
      <div class="fr-col-12 fr-col-lg-9">
        <div class="fr-grid-row fr-grid-row--gutters">
          <div class="fr-col-3">
            <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">AE HT2</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[0])%>€</p>
              </div>
            </div>
          </div>
          <div class="fr-col-3">
            <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">CP HT2</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[1])%>€</p>
              </div>
            </div>
          </div>
          <div class="fr-col-3">
            <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">AE/CP T2</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[2])%>€</p>
              </div>
            </div>
          </div>
          <div class="fr-col-3">
            <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">ETPT</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[3])%>€</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% if Date.today >= @date2 %>
      <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle" >
        <div class="fr-col-12 fr-col-lg-1">
          CRG1
        </div>
        <div class="fr-col-12 fr-col-lg-9">
          <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-3">
              <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">AE HT2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[0])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">CP HT2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[1])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">AE/CP T2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[2])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">ETPT</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[3])%>€</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    <% if Date.today >= @date1 %>
      <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle" >
        <div class="fr-col-12 fr-col-lg-1">
          Début de gestion
        </div>
        <div class="fr-col-12 fr-col-lg-9">
          <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-3">
              <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">AE HT2 </p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[0])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">CP HT2 </p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[1])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">AE/CP T2 </p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[2])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--green fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">ETPT</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[3])%>€</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    <h3 class="fr-mt-3w">Prévision d’exécution</h3>
    <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle" >
      <div class="fr-col-12 fr-col-lg-1">
        <%= @phase %>
      </div>
      <div class="fr-col-12 fr-col-lg-9">
        <div class="fr-grid-row fr-grid-row--gutters">
          <div class="fr-col-3">
            <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">AE HT2</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[4])%>€</p>
              </div>
            </div>
          </div>
          <div class="fr-col-3">
            <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">CP HT2</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[5])%>€</p>
              </div>
            </div>
          </div>
          <div class="fr-col-3">
            <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">AE/CP T2</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[6])%>€</p>
              </div>
            </div>
          </div>
          <div class="fr-col-3">
            <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">ETPT</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[7])%>€</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% if Date.today >= @date2 %>
      <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle" >
        <div class="fr-col-12 fr-col-lg-1">
          CRG1
        </div>
        <div class="fr-col-12 fr-col-lg-9">
          <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-3">
              <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">AE HT2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[4])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">CP HT2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[5])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">AE/CP T2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[6])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">ETPT</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[7])%>€</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    <% if Date.today >= @date1 %>
      <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle" >
        <div class="fr-col-12 fr-col-lg-1">
          Début de gestion
        </div>
        <div class="fr-col-12 fr-col-lg-9">
          <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-3">
              <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">AE HT2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[4])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">CP HT2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[5])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">AE/CP T2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[6])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--orange fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">ETPT</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[7])%>€</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    <h3 class="fr-mt-3w">Écarts ressources allouées/prévision d’exécution</h3>
    <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle" >
      <div class="fr-col-12 fr-col-lg-1">
        <%= @phase %>
      </div>
      <div class="fr-col-12 fr-col-lg-9">
        <div class="fr-grid-row fr-grid-row--gutters">
          <div class="fr-col-3">
            <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">Écart AE HT2</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[4] - @data[0])%>€</p>
              </div>
            </div>
          </div>
          <div class="fr-col-3">
            <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">Écart CP HT2</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[5] - @data[1])%>€</p>
              </div>
            </div>
          </div>
          <div class="fr-col-3">
            <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">Écart AE/CP T2</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[6] - @data[2])%>€</p>
              </div>
            </div>
          </div>
          <div class="fr-col-3">
            <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
              <div class="fr-cart__body">
                <p class="fr-text--lg fr-mb-0 text_center">Écart ETPT</p>
                <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data[7] - @data[3])%>€</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% if Date.today >= @date2 %>
      <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle" >
        <div class="fr-col-12 fr-col-lg-1">
          CRG1
        </div>
        <div class="fr-col-12 fr-col-lg-9">
          <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-3">
              <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">Écart AE HT2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[4] - @data_c[0])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">Écart CP HT2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[5] - @data_c[1])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">Écart AE/CP T2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[6] - @data_c[2])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">Écart ETPT</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_c[7] - @data_c[3])%>€</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    <% if Date.today >= @date1 %>
      <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle" >
        <div class="fr-col-12 fr-col-lg-1">
          Début de gestion
        </div>
        <div class="fr-col-12 fr-col-lg-9">
          <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-3">
              <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">Écart AE HT2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[4] - @data_d[0])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">Écart CP HT2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[5] - @data_d[1])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">Écart AE/CP T2</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[6] - @data_d[2])%>€</p>
                </div>
              </div>
            </div>
            <div class="fr-col-3">
              <div class="fr-card fr-card--blue fr-p-2w fr-card--no-border">
                <div class="fr-cart__body">
                  <p class="fr-text--lg fr-mb-0 text_center">Écart ETPT</p>
                  <p class="fr-text--lg fr-text--bold fr-mb-0 text_center"><%= format_number(@data_d[7] - @data_d[3])%>€</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
  <h2 class="fr-mb-2w fr-mt-4w">Statistiques sur le programme</h2>
  <div class="fr-grid-row fr-grid-row--gutters" >
    <div class="fr-col-12 fr-col-lg-4">
      <div data-highcharts-target="canvasAvisDate"></div>
    </div>
    <div class="fr-col-12 fr-col-lg-4">
      <div data-highcharts-target="canvasAvis"></div>
    </div>
    <div class="fr-col-12 fr-col-lg-4">
        <div data-highcharts-target="canvasNotesBar"></div>
    </div>
  </div>
  <div class="fr-grid-row fr-grid-row--gutters fr-mt-4w">
    <div class="fr-col-12 fr-col-lg-12">
      <h2 class="fr-mb-2w">Liste des <%= @bops_count %> BOP du programme</h2>
    </div>
  </div>
  <div class="fr-accordions-group fr-mb-4w">
    <% @bops.each do |bop| %>
    <section class="fr-accordion">
      <h3 class="fr-accordion__title">
        <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-<%=bop.id %>">BOP n°<%= bop.code %>
          <% unless @bops_avis_debut[bop.id].nil?%>
            <% if @bops_avis_debut[bop.id][0] == "Favorable" %>
              <p class="fr-badge fr-badge--success fr-badge--no-icon fr-ml-2w">Avis Favorable</p>
            <% elsif @bops_avis_debut[bop.id][0] == "Favorable avec réserve" %>
              <p class="fr-badge fr-badge--new fr-badge--no-icon fr-ml-2w">Avis Favorable avec réserve</p>
            <% elsif @bops_avis_debut[bop.id][0] == "Défavorable" %>
              <p class="fr-badge fr-badge--warning fr-badge--no-icon fr-ml-2w">Avis Défavorable</p>
            <% end %>
          <%end %>
          <% unless @bops_avis_crg1[bop.id].nil? %>
            <% if @bops_avis_crg1[bop.id][0] == "Aucun risque" %>
              <p class="fr-badge fr-badge--success fr-badge--no-icon fr-ml-2w">BOP avec capacité contributive</p>
            <% elsif @bops_avis_crg1[bop.id][0] == "Risques éventuels ou modérés" %>
              <p class="fr-badge fr-badge--new fr-badge--no-icon fr-ml-2w">BOP avec consommation à la ressource</p>
            <% elsif @bops_avis_crg1[bop.id][0] == "Risques certains ou significatifs" %>
              <p class="fr-badge fr-badge--warning fr-badge--no-icon fr-ml-2w">BOP avec besoin de financement</p>
            <% end %>
          <%end %>
          <% unless @bops_avis_crg2[bop.id].nil? %>
            <% if @bops_avis_crg2[bop.id][0] == "Aucun risque" %>
              <p class="fr-badge fr-badge--success fr-badge--no-icon fr-ml-2w">BOP avec capacité contributive</p>
            <% elsif @bops_avis_crg2[bop.id][0] == "Risques éventuels ou modérés" %>
              <p class="fr-badge fr-badge--new fr-badge--no-icon fr-ml-2w">BOP avec consommation à la ressource</p>
            <% elsif @bops_avis_crg2[bop.id][0] == "Risques certains ou significatifs" %>
              <p class="fr-badge fr-badge--warning fr-badge--no-icon fr-ml-2w">BOP avec besoin de financement</p>
            <% end %>
          <%end %>
        </button>
      </h3>
      <div class="fr-collapse" id="accordion-<%=bop.id %>">
        <p class="fr-tag fr-mb-2w"><%= @bops_user[bop.id]%></p>
        <ul class="fr-btns-group fr-btns-group--inline">
          <% if @bops_avis_debut[bop.id].nil? %>
            <li>
              <button class="fr-btn" disabled>
                Avis début de gestion
              </button>
            </li>
          <%else %>
            <li>
              <%= link_to open_modal_path(id: @bops_avis_debut[bop.id][1]), class:"fr-btn","data-fr-opened": false,"aria-controls":"modal-1",data: { "turbo_method": :post} do %>Avis début de gestion<%end %>
            </li>
          <%end %>
          <% if @bops_avis_crg1[bop.id].nil? %>
            <li>
              <button class="fr-btn" disabled>
                Note CRG1
              </button>
            </li>
          <%else %>
            <li>
              <%= link_to open_modal_path(id: @bops_avis_crg1[bop.id][1]), class:"fr-btn","data-fr-opened": false,"aria-controls":"modal-1",data: { "turbo_method": :post} do %>Note CRG1<%end %>
            </li>
          <%end %>
          <% if @bops_avis_crg2[bop.id].nil?%>
            <li>
              <button class="fr-btn" disabled>
                Note CRG2
              </button>
            </li>
          <%else %>
            <li>
              <%= link_to open_modal_path(id: @bops_avis_crg2[bop.id][1]), class:"fr-btn","data-fr-opened": false,"aria-controls":"modal-1",data: { "turbo_method": :post} do %>Note CRG2<%end %>
            </li>
          <%end %>
        </ul>
     </div>
    </section>
    <%end  %>
  </div>
  <dialog id="modal-1" class="fr-modal" aria-labelledby="modal-1-title">
    <div id="debut">
      <%= render partial: 'avis/dialog_debut',locals: {avis: @avis_default} %>
    </div>
  </dialog>
</div>