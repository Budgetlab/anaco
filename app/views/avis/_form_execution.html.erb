<div class="fr-container" >
  <nav role="navigation" class="fr-breadcrumb" aria-label="vous êtes ici :">
    <button class="fr-breadcrumb__button " aria-expanded="false" aria-controls="breadcrumb-1" title="voir le fil d'ariane">Voir le fil d’Ariane</button>
    <div class="fr-collapse" id="breadcrumb-1">
      <ol class="fr-breadcrumb__list">
        <li>
          <%= link_to root_path, class:"fr-breadcrumb__link" do %> Accueil <%end %>
        </li>
        <li>
          <%= link_to bops_path, class:"fr-breadcrumb__link" do %> BOP et avis <%end %>
        </li>
        <li>
          <a class="fr-breadcrumb__link" aria-current="page">Formulaire début de gestion</a>
        </li>
      </ol>
    </div>
  </nav>
  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12 fr-col-lg-12">
      <h1>Formulaire début de gestion <%= @annee %></h1>
      <div class="fr-h3 fr-mb-0">BOP n°<%= @bop.code%> </div>
      <div>
        <p class="fr-badge fr-badge--sm fr-badge--blue-ecume"><% if @bop.dotation == "aucune" %>BOP inactif<%elsif @bop.dotation == "complete" %>BOP doté en HT2 et T2<%elsif @bop.dotation == "HT2" %>BOP doté uniquement en HT2<%elsif @bop.dotation == "T2" %>BOP doté uniquement en T2<%else %>BOP actif<%end %></p>
      </div>
    </div>
  </div>

  <% if @avis_execution.nil? %>
    <div class="fr-alert fr-alert--info fr-mt-4w fr-mb-6w">
      <h3 class="fr-alert__title">Données d'exécution <%= @annee -1 %> à venir</h3>
      <p>Les données d'exécution <%= @annee -1 %> n'ont pas encore été chargées dans l'outil. Vous pourrez renseigner l'avis de début de gestion une fois ces données importées dans l'outil.</p>
    </div>
  <%else%>
    <div class="cwarning fr-mt-2w">Tous les champs comportant un astérisque (*) sont à remplir obligatoirement.</div>
    <h3 class="fr-mt-4w fr-mb-2w">Exécution <%= @annee -1 %></h3>
    <div class="fr-alert fr-alert--info fr-my-0w">
      <h3 class="fr-alert__title">Les données d’exécution <%= @annee -1 %> sont issues de Chorus.</h3>
      <p>Vous pouvez commenter ces données dans l’espace commentaire et signaler si les chiffres de l'ordonnateur ne correspondent pas.</p>
    </div>
    <div class="fr-mt-4w" data-controller="form">
      <%= form_with(model: @avis, url: avis_path, method: :post, data: {'form-target': "form", action: "input->form#formChange turbo:before-fetch-request->form#submitForm"}) do |f|%>
        <%= f.hidden_field :bop_id, value: @bop.id%>
        <%= f.hidden_field :etat, value: "valide"%>
        <%= f.hidden_field :phase, value: "execution"%>
        <div class="fr-grid-row fr-grid-row--gutters fr-mb-4w">
          <div class="fr-col-12 fr-col-lg-12">
            <% if @avis_crg2_n1 %>
              <section class="fr-accordion">
                <h3 class="fr-accordion__title">
                  <button class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-80" data-action="click->form#save"><p class="fr-badge fr-badge--info fr-badge--no-icon fr-mr-1w">Rappel avis CRG2 <%= @annee - 1 %></p> Écart ressource/prévision de consommation</button>
                </h3>
                <div class="fr-collapse" id="accordion-80">
                  <%= render partial: "avis/rappel_ecart", locals: {avis: @avis_crg2_n1} %>
                </div>
              </section>
            <% end  %>
            <div class="fr-accordion__title fr-mt-3w">Ressources disponibles (en €)</div>
            <hr class="fr-col_12">
            <%= render partial: "avis/rappel_chiffres", locals: {avis: [@avis.ae_i, @avis.cp_i, @avis.t2_i, @avis.etpt_i], titre: '', class_active: 'fr-card--green'} %>
            <div class="fr-accordion__title fr-mt-3w">Ressources consommées (en €)</div>
            <hr class="fr-col_12">
            <%= render partial: "avis/rappel_chiffres", locals: {avis: [@avis.ae_f, @avis.cp_f, @avis.t2_f, @avis.etpt_f], titre: '', class_active: 'fr-card--orange'} %>
            <div class="fr-accordion__title fr-mt-3w">Solde d’exécution</div>
            <hr class="fr-col_12">
            <%= render partial: "avis/rappel_ecart", locals: {avis: @avis} %>
            <div class="fr-input-group fr-mt-3w">
              <label class="fr-label" for="commentaire">
                Observations sur l’écart*
                <span class="fr-hint-text">800 caractères recommandés, espaces compris</span>
              </label>
              <%= f.text_area :commentaire, data: {'form-target': 'fieldRequire', action: "input->form#calculNombreCaracteres" }, class:"fr-input", id:"commentaire", rows: 10, value: @avis.commentaire%>
              <p class="fr-message fr-message--info"><span class="fr-mr-1v" data-form-target="count">0 </span> caractères</p>
            </div>
            <div><%= f.submit "Valider et passer à l'avis de début de gestion", class: "fr-btn", data: {'form-target': "Btnvalidate"}, aria: { label: "Valider"} %></div>
          </div>
        </div>
      <% end  %>
    </div>
  <% end %>
</div>