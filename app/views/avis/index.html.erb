<% content_for :title do %>Historique des avis | ANACO
<% end %>
<div class="fr-container">
  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12 fr-col-lg-12">
      <h1 class="fr-mt-6w">Historique des avis/notes</h1>
      <%= render 'avis/success' %>

      <%= turbo_frame_tag :table, data: { turbo_action: 'advance' } do %>
        <div class="fr-table--lg fr-table fr-table--no-caption fr-mb-6w">
          <div class="fr-table__header">
            <p class="fr-table__detail"></p>
            <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-md fr-btns-group--icon-left">
              <li>
                <button class="fr-btn fr-icon-filter-line fr-btn--icon-left " aria-controls="modal-btn-filtrer" data-fr-opened="false" type="button">
                  Filtrer les résultats <%= " (#{@filtres_count})" if @filtres_count > 0 %>
                </button>
              </li>
              <li>
                <%= link_to historique_path(format: :xlsx, q: params[:q]&.to_unsafe_h),
                            class: "fr-btn fr-icon-download-line fr-btn--icon-left fr-btn--secondary",
                            data: { turbo: false } do %> Télécharger les avis/notes (<%= @avis_all.count %>)
                <% end %>
              </li>
            </ul>
          </div>
          <div class="fr-table__wrapper">
            <div class="fr-table__container">
              <div class="fr-table__content">
                <table class="fr-cell--multiline">
                  <caption>Historique des avis</caption>
                  <thead>
                  <tr>
                    <% if current_user.statut == "admin" %>
                      <th scope="col">CBR/DCB</th>
                    <% end %>
                    <th scope="col">Phase</th>
                    <th scope="col">Exercice</th>
                    <th scope="col">BOP</th>
                    <th scope="col">Programme</th>
                    <th scope="col">Statut/Risque</th>
                    <th scope="col">État</th>
                    <th scope="col">Action</th>
                  </tr>
                  </thead>

                  <tbody>
                  <% @avis_page&.each do |avis| %>
                    <tr>
                      <% if current_user.statut == "admin" %>
                        <td><%= avis.user.nom %> </td>
                      <% end %>
                      <td>
                        <div class="fr-capitalize"><%= avis.phase %></div>
                        <% if avis.phase == 'services votés' %>
                          n°<%= numero_avis_services_votes(avis, @avis_page) %>
                        <% end %>
                      </td>
                      <td><%= avis.annee %></td>

                      <td><%= link_to bop_path(avis.bop_id), data: { turbo_frame: "_top" } do %><%= avis.bop.code %>
                        <% end %></td>
                      <td><%= avis.bop.numero_programme %> - <%= avis.bop.nom_programme %> </td>
                      <td><%= avis.statut %></td>
                      <td>
                        <p class="<%= badge_class_for_etat(avis.etat) %>"><%= avis.etat %></p>
                      </td>

                      <td>
                        <% if avis.etat == "Brouillon" %>
                          <% if current_user.statut != "admin" %>
                            <%= link_to edit_bop_avi_path(bop_id: avis.bop_id, id: avis.id), data: { turbo_frame: '_top' }, class: "fr-btn fr-btn--sm" do %>
                              Reprendre
                            <% end %>
                          <% end %>
                        <% else %>
                          <a href="<%= avi_path(avis) %>" data-turbo-frame="modal" class="fr-btn fr-btn--sm" data-fr-opened="false" aria-controls="modal-1">
                            Consulter
                          </a>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>

                  </tbody>

                </table>
              </div>
            </div>
          </div>
          <div class="fr-table__footer">
            <div class="fr-table__footer--start">
              <p class="fr-table__detail"><%= pluralize(@avis_all.length, 'résultat', plural: 'résultats') %></p>
              <div class="fr-select-group">
                <label class="fr-sr-only fr-label" for="table-footer-select-7847">
                  Nombre de lignes par page
                </label>
                <div class="fr-messages-group" id="table-footer-select-7847-messages" aria-live="polite"></div>
              </div>
            </div>
            <div class="fr-table__footer--middle">
              <%== pagy_nav_custom(@pagy) %>
            </div>
          </div>
        </div>
      <% end %>

      <dialog id="modal-1" class="fr-modal">
        <%= turbo_frame_tag :modal, target: "_top" %>
      </dialog>
    </div>
  </div>
</div>
<dialog id="modal-btn-filtrer" class="fr-modal fr-modal--top fr-modal--custom" aria-labelledby="modal-btn-filtrer-title" data-fr-concealing-backdrop="true">
  <div class="fr-container--fluid">
    <div class="fr-modal-custom__row--left">
      <div class="fr-col-12">
        <div class="fr-modal-custom__body">
          <div class="fr-modal__header">
            <button aria-controls="modal-btn-filtrer" title="Fermer" type="button" id="button-11" class="fr-btn--close fr-btn">Fermer</button>
          </div>
          <%= search_form_for @q, url: historique_path, data: { 'request-target': 'form', turbo_frame: 'table', turbo_action: 'advance' } do |f| %>
            <div class="fr-modal__content">
              <h2 id="modal-btn-filtrer-title" class="fr-modal__title">
                Filtrer les résultats
              </h2>
              <div class="fr-grid-row fr-grid-row--gutters">
                <div class="fr-col-12">
                  <div>
                    <span class="fr-label fr-text--bold">Phase</span>
                    <ul class="fr-tags-group fr-mt-1w">
                      <% selected_types = Array(params.dig(:q, :phase_in)) %>
                      <% ["services votés", "début de gestion", "CRG1", "CRG2"].each do |t| %>
                        <li>
                          <label class="fr-tag tag-selectable"
                                 data-controller="tag-select"
                                 data-action="change->tag-select#toggle"
                                 role="button">
                            <%= check_box_tag 'q[phase_in][]',
                                              t,
                                              selected_types.include?(t),
                                              class: "fr-sr-only",
                                              data: { tag_select_target: "checkbox" } %>
                            <span><%= t %></span>
                          </label>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                  <div>
                    <span class="fr-label fr-text--bold">Exercice</span>
                    <% selected_years = Array(params.dig(:q, :annee_in)).map(&:to_s) %>
                    <ul class="fr-tags-group fr-mt-1w">
                      <% (2023..Date.today.year).each do |y| %>
                        <% y_str = y.to_s %>
                        <% checked = selected_years.include?(y_str) %>
                        <li>
                          <label class="fr-tag tag-selectable <%= 'is-selected' if checked %>"
                                 data-controller="tag-select"
                                 data-action="change->tag-select#toggle"
                                 role="button">
                            <%= check_box_tag 'q[annee_in][]',
                                              y_str,
                                              checked,
                                              class: "fr-sr-only",
                                              data: { tag_select_target: "checkbox" } %>
                            <span><%= y_str %></span>
                          </label>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                  <div>
                    <span class="fr-label fr-text--bold">État</span>
                    <ul class="fr-tags-group fr-mt-1w">
                      <% selected_types = Array(params.dig(:q, :etat_in)) %>
                      <% ["Lu", "En attente de lecture", "Brouillon"].each do |t| %>
                        <li>
                          <label class="fr-tag tag-selectable"
                                 data-controller="tag-select"
                                 data-action="change->tag-select#toggle"
                                 role="button">
                            <%= check_box_tag 'q[etat_in][]',
                                              t,
                                              selected_types.include?(t),
                                              class: "fr-sr-only",
                                              data: { tag_select_target: "checkbox" } %>
                            <span><%= t %></span>
                          </label>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                  <div>
                    <span class="fr-label fr-text--bold">Statut/Risque</span>
                    <ul class="fr-tags-group fr-mt-1w">
                      <% selected_types = Array(params.dig(:q, :statut_in)) %>
                      <% ["Favorable", "Favorable avec réserve", "Défavorable", "Aucun risque", "Risques éventuels ou modérés", "Risques certains ou significatifs"].each do |t| %>
                        <li>
                          <label class="fr-tag tag-selectable"
                                 data-controller="tag-select"
                                 data-action="change->tag-select#toggle"
                                 role="button">
                            <%= check_box_tag 'q[statut_in][]',
                                              t,
                                              selected_types.include?(t),
                                              class: "fr-sr-only",
                                              data: { tag_select_target: "checkbox" } %>
                            <span><%= t %></span>
                          </label>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                </div>

                <div class="fr-col-12">
                  <label class="fr-label fr-text--bold">Programme/BOP</label>
                  <%= f.search_field :bop_code_cont, class: "fr-input", placeholder: 'Rechercher sur un programme/BOP' %>
                </div>
                <% if @statut_user == 'admin' %>
                  <div class="fr-col-12">
                    <label class="fr-label fr-text--bold">Contrôleur</label>
                    <% noms = User.where(statut: ['DCB', 'CBR']).distinct.order(nom: :asc).pluck(:nom) %>
                    <%= f.select :user_nom_eq, options_for_select(noms, params.dig(:q, :user_nom_in)), { include_blank: 'Tous' }, class: "fr-select" %>
                  </div>
                <% end %>
                <div class="fr-col-12">
                  <span class="fr-label fr-text--bold">Date avis/note entre</span>

                  <div class="fr-grid-row fr-grid-row--gutters">
                    <div class="fr-col-12 fr-col-md-6">
                      <%= f.label :date_envoi_gteq, 'Du', class: 'fr-label' %>
                      <%= f.date_field :date_envoi_gteq,
                                       class: 'fr-input',
                                       value: params.dig(:q, :date_envoi_gteq) %>
                    </div>

                    <div class="fr-col-12 fr-col-md-6">
                      <%= f.label :date_envoi_lteq, 'Au', class: 'fr-label' %>
                      <%= f.date_field :date_envoi_lteq,
                                       class: 'fr-input',
                                       value: params.dig(:q, :date_envoi_lteq) %>
                    </div>
                  </div>
                </div>

                <div class="fr-col-12">
                  <label class="fr-label fr-text--bold">Trier par</label>
                  <%= f.select :s,
                               options_for_select(
                                 [
                                   ['Par défaut (dernière modification)', 'updated_at desc'],
                                   ['Date avis/notre croissante', 'date_envoi asc'],
                                   ['Date avis/notre décroissante', 'date_envoi desc'],
                                 ],
                                 params.dig(:q, :s)
                               ),
                               { include_blank: false },
                               class: "fr-select" %>
                </div>
              </div>
            </div>
            <div class="fr-modal__footer">
              <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                <li>
                  <%= f.submit 'Valider', class: "fr-btn fr-icon-checkbox-circle-line fr-btn--icon-left", 'aria-controls': "modal-btn-filtrer" %>
                </li>
                <li>
                  <%= link_to historique_ht2_path, class: "fr-btn fr-icon-close-circle-line fr-btn--icon-left fr-btn--secondary" do %>
                    Réinitialiser
                  <% end %>
                </li>
              </ul>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</dialog>