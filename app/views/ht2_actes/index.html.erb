<% content_for :title do %>Liste des actes | ANACO
<% end %>
<div class="fr-container">
  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12 fr-col-lg-12">
      <h1 class="fr-mt-6w title-btn">
        Actes HT2
        <% if ['DCB', 'CBR'].include?(@statut_user) %>
          <nav role="navigation" class="fr-translate fr-nav" id="translate-id">
            <div class="fr-nav__item fr-nav--dropdown">
              <button aria-controls="menu-add-acte" aria-expanded="false" type='button' id='button-add' class="fr-btn fr-icon-add-line fr-btn--icon-left">Nouvel
                acte
              </button>
              <div class="fr-collapse fr-menu fr-menu--dropdown" id="menu-add-acte">
                <ul class="fr-menu__list">
                  <li>
                    <%= link_to new_ht2_acte_path(type_acte: 'avis'), class: 'fr-nav__link' do %>
                      Nouvel avis
                    <% end %>
                  </li>
                  <li>
                    <%= link_to new_ht2_acte_path(type_acte: 'visa'), class: 'fr-nav__link' do %>
                      Nouveau visa
                    <% end %>
                  </li>
                  <li>
                    <%= link_to new_ht2_acte_path(type_acte: 'TF'), class: 'fr-nav__link' do %>
                      Nouvelle TF
                    <% end %>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
        <% end %>
      </h1>
    </div>
  </div>

  <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--middle">
    <div class="fr-col-12 title-btn">
      <div class="flex-grow fr-mr-2w" data-controller="request">
        <%= search_form_for @q, data: { 'request-target': 'form', turbo_frame: 'table', turbo_action: 'advance' } do |f| %>
          <div class="fr-search-bar" role="search">
            <label class="fr-label" for="search-input"> Rechercher </label>
            <%= f.search_field :numero_chorus_or_centre_financier_code_or_instructeur_or_valideur_cont,
                               placeholder: "Rechercher un acte par n°Chorus, centre financier, instructeur, valideur",
                               class: "fr-input",
                               id: "search-input", oninput: 'this.form.requestSubmit()' %>
            <button class="fr-btn" title="Rechercher">Rechercher</button>
          </div>
        <% end %>
      </div>
      <div>
        <button class="fr-btn fr-icon-download-line fr-btn--icon-left fr-btn--secondary"><%= link_to ht2_actes_path(format: :xlsx) do %>
            Télécharger les actes
          <% end %></button>
      </div>
    </div>
  </div>
  <%= render 'ht2_actes/flash_message' %>
  <%= turbo_frame_tag :table, data: { turbo_action: 'advance' } do %>
    <% if ['DCB', 'CBR'].include?(@statut_user) %>
      <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-lg-12">
          <h2 class="fr-mt-6w">Actes en pré-instruction [<%= @actes_pre_instruction_all.count %>]</h2>
          <% if @actes_pre_instruction.present? %>
            <div class="fr-table--lg fr-table fr-table--no-caption">
              <div class="fr-table__wrapper">
                <div class="fr-table__container">
                  <div class="fr-table__content">
                    <table>
                      <caption>Actes en pré-instruction</caption>
                      <thead>
                      <tr class="fr-cell--multiline">
                        <th scope="col">N°acte</th>
                        <th scope="col">Date création</th>
                        <th scope="col">Agent</th>
                        <th scope="col">Nature</th>
                        <th scope="col">Montant</th>
                        <th scope="col"></th>
                      </tr>
                      </thead>
                      <tbody>
                      <% @actes_pre_instruction.each do |acte| %>
                        <tr>
                          <td><p class="fr-badge <%= badge_class_for_type(acte.type_acte) %>"><%= acte.type_acte %></p>
                            n°<%= acte.numero_utilisateur %></td>
                          <td><%= l(acte.created_at, format: "%e/%m/%y") %></td>
                          <td><p class="fr-tag"><%= acte.instructeur %></p></td>
                          <td class="fr-cell--multiline"><%= acte.nature %></td>
                          <td><%= number_to_currency(acte.montant_ae, unit: "€", format: "%n %u") %></td>
                          <td>
                            <div class="fr-align-center">
                              <%= link_to edit_ht2_acte_path(acte), class: 'fr-btn fr-btn--secondary fr-btn--sm', data: { turbo_frame: "_top" } do %>
                                Actualiser
                              <% end %>
                              <%= link_to ht2_acte_path(acte), data: { 'turbo-method': :delete, turbo_confirm: 'Confirmer la suppression?' }, class: 'fr-btn fr-btn--sm fr-icon-delete-bin-line' do %>
                                Supprimer
                              <% end %>
                            </div>
                          </td>
                        </tr>
                      <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="fr-table__footer">
                <div class="fr-table__footer--start">
                  <p class="fr-table__detail"><%= pluralize(@actes_pre_instruction_all.count, 'résultat', plural: 'résultats') %></p>
                  <div class="fr-select-group">
                    <label class="fr-sr-only fr-label" for="table-footer-select-7847">
                      Nombre de lignes par page
                    </label>
                    <div class="fr-messages-group" id="table-footer-select-7847-messages" aria-live="polite"></div>
                  </div>
                </div>
                <div class="fr-table__footer--middle">
                  <%== pagy_nav_custom(@pagy_pre_instruction) %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-lg-12">
          <h2 class="fr-mt-2w">Actes en cours d'instruction [<%= @actes_instruction_all.count %>]</h2>
          <% if @actes_instruction.present? %>
            <div class="fr-table--lg fr-table fr-table--no-caption fr-mb-4w">
              <div class="fr-table__wrapper">
                <div class="fr-table__container">
                  <div class="fr-table__content">
                    <table>
                      <caption>Actes en cours d'instruction</caption>
                      <thead>
                      <tr class="fr-cell--multiline">
                        <th scope="col">N°acte</th>
                        <th scope="col">Agent</th>
                        <th scope="col">Nature</th>
                        <th scope="col">Montant</th>
                        <th scope="col">N°Chorus</th>
                        <th scope="col">Date réception Chorus</th>
                        <th scope="col">
                          <% sort_date = "" %>
                          <% if params[:q_instruction] && params[:q_instruction][:s] == "date_limite desc" %>
                            <% sort_date = "asc" %>
                          <% elsif params[:q_instruction] && params[:q_instruction][:s] == "date_limite asc" %>
                            <% sort_date = "desc" %>
                          <% end %>
                          <div class="fr-cell--sort">
                            <span class="fr-cell__title">Date limite de réponse</span>
                            <%= sort_link(@q_instruction, :date_limite, '', default_order: :desc, class: 'fr-btn--sort fr-btn fr-btn--sm', aria: { sorting: sort_date }) %>
                          </div>
                        </th>
                        <th scope="col"></th>
                      </tr>
                      </thead>
                      <tbody>
                      <% @actes_instruction.each do |acte| %>
                        <tr>
                          <td><p class="fr-badge <%= badge_class_for_type(acte.type_acte) %>"><%= acte.type_acte %></p>
                            n°<%= acte.numero_utilisateur %></td>
                          <td><p class="fr-tag"><%= acte.instructeur %></p></td>
                          <td class="fr-cell--multiline"><%= acte.nature %></td>
                          <td><%= number_to_currency(acte.montant_ae, unit: "€", format: "%n %u") %></td>
                          <td><%= acte.numero_chorus %></td>
                          <td><%= l(acte.date_chorus, format: "%e/%m/%y") %></td>
                          <td>
                            <span class='fr-icon-flag-fill fr-mr-1v fr-icon--sm <%= flag_date(acte.date_limite) %>' aria-hidden='true'></span><%= l(acte.date_limite, format: "%e/%m/%y") %>
                          </td>
                          <td>
                            <div class="fr-align-center">
                              <%= link_to edit_ht2_acte_path(acte), class: 'fr-btn fr-btn--secondary fr-btn--sm', data: { turbo_frame: "_top" } do %>
                                Actualiser
                              <% end %>
                              <%= link_to ht2_acte_path(acte), data: { 'turbo-method': :delete, turbo_confirm: 'Confirmer la suppression?' }, class: 'fr-btn fr-btn--sm fr-icon-delete-bin-line' do %>
                                Supprimer
                              <% end %>
                            </div>
                          </td>
                        </tr>
                      <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="fr-table__footer">
                <div class="fr-table__footer--start">
                  <p class="fr-table__detail"><%= pluralize(@actes_instruction_all.count, 'résultat', plural: 'résultats') %></p>
                  <div class="fr-select-group">
                    <label class="fr-sr-only fr-label" for="table-footer-select-7847">
                      Nombre de lignes par page
                    </label>
                    <div class="fr-messages-group" id="table-footer-select-7847-messages" aria-live="polite"></div>
                  </div>
                </div>
                <div class="fr-table__footer--middle">
                  <%== pagy_nav_custom(@pagy_instruction) %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-lg-12">
          <h2 class="fr-mt-2w">Actes suspendus/interrompus [<%= @actes_suspendu_all.count %>]</h2>
          <% if @actes_suspendu.present? %>
            <div class="fr-table--lg fr-table fr-table--no-caption fr-mb-4w">
              <div class="fr-table__wrapper">
                <div class="fr-table__container">
                  <div class="fr-table__content">
                    <table>
                      <caption>Actes suspendus</caption>
                      <thead>
                      <tr class="fr-cell--multiline">
                        <th scope="col">N°acte</th>
                        <th scope="col">Agent</th>
                        <th scope="col">Nature</th>
                        <th scope="col">Montant</th>
                        <th scope="col">N°Chorus</th>
                        <th scope="col">Date de suspension</th>
                        <th scope="col"></th>
                      </tr>
                      </thead>
                      <tbody>
                      <% @actes_suspendu.each do |acte| %>
                        <tr>
                          <td><p class="fr-badge <%= badge_class_for_type(acte.type_acte) %>"><%= acte.type_acte %></p>
                            n°<%= acte.numero_utilisateur %></td>
                          <td><p class="fr-tag"><%= acte.instructeur %></p></td>
                          <td class="fr-cell--multiline"><%= acte.nature %></td>
                          <td><%= number_to_currency(acte.montant_ae, unit: "€", format: "%n %u") %></td>
                          <td><%= acte.numero_chorus %></td>
                          <td><%= l(acte.last_date_suspension, format: "%e/%m/%y") %></td>
                          <td><%= link_to edit_ht2_acte_path(acte, etape: 6), class: 'fr-btn fr-btn--secondary fr-btn--sm', data: { turbo_frame: "_top" } do %>
                              Actualiser
                            <% end %></td>
                        </tr>
                      <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="fr-table__footer">
                <div class="fr-table__footer--start">
                  <p class="fr-table__detail"><%= pluralize(@actes_suspendu_all.count, 'résultat', plural: 'résultats') %></p>
                  <div class="fr-select-group">
                    <label class="fr-sr-only fr-label" for="table-footer-select-7847">
                      Nombre de lignes par page
                    </label>
                    <div class="fr-messages-group" id="table-footer-select-7847-messages" aria-live="polite"></div>
                  </div>
                </div>
                <div class="fr-table__footer--middle">
                  <%== pagy_nav_custom(@pagy_suspendu) %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-lg-12">
          <h2 class="fr-mt-2w">Actes en attente de validation [<%= @actes_validation_all.count %>]</h2>
          <% if @actes_validation.present? %>
            <div class="fr-table--lg fr-table fr-table--no-caption fr-mb-4w">
              <div class="fr-table__wrapper">
                <div class="fr-table__container">
                  <div class="fr-table__content">
                    <table>
                      <caption>Actes en attente de validation</caption>
                      <thead>
                      <tr class="fr-cell--multiline">
                        <th scope="col">N°acte</th>
                        <th scope="col">Agent</th>
                        <th scope="col">Nature</th>
                        <th scope="col">Montant</th>
                        <th scope="col">N°Chorus</th>
                        <th scope="col">
                          <% sort_date = "" %>
                          <% if params[:q_validation] && params[:q_validation][:s] == "date_limite desc" %>
                            <% sort_date = "asc" %>
                          <% elsif params[:q_validation] && params[:q_validation][:s] == "date_limite asc" %>
                            <% sort_date = "desc" %>
                          <% end %>
                          <div class="fr-cell--sort">
                            <span class="fr-cell__title">Date limite de réponse</span>
                            <%= sort_link(@q_validation, :date_limite, '', default_order: :desc, class: 'fr-btn--sort fr-btn fr-btn--sm', aria: { sorting: sort_date }) %>
                          </div>
                        </th>
                        <th scope="col">Proposition de décision</th>
                        <th scope="col"></th>
                      </tr>
                      </thead>
                      <tbody>
                      <% @actes_validation.each do |acte| %>
                        <tr>
                          <td><p class="fr-badge <%= badge_class_for_type(acte.type_acte) %>"><%= acte.type_acte %></p>
                            n°<%= acte.numero_utilisateur %></td>
                          <td><p class="fr-tag"><%= acte.instructeur %></p></td>
                          <td class="fr-cell--multiline"><%= acte.nature %></td>
                          <td><%= number_to_currency(acte.montant_ae, unit: "€", format: "%n %u") %></td>
                          <td><%= acte.numero_chorus %></td>
                          <td>
                            <span class='fr-icon-flag-fill fr-mr-1v fr-icon--sm <%= flag_date(acte.date_limite) %>' aria-hidden='true'></span><%= l(acte.date_limite, format: "%e/%m/%y") %>
                          </td>
                          <td class="fr-cell--multiline">
                            <p class="<%= badge_class_for_decision(acte.proposition_decision) %>"><%= acte.proposition_decision %></p>
                          </td>
                          <td>
                            <a href="<%= validate_acte_path(acte) %>" data-turbo-frame="acte" class="fr-btn fr-btn--secondary fr-btn--sm" data-fr-opened="false" aria-controls="modal-acte">
                              Actualiser
                            </a>
                          </td>
                        </tr>
                      <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="fr-table__footer">
                <div class="fr-table__footer--start">
                  <p class="fr-table__detail"><%= pluralize(@actes_validation_all.count, 'résultat', plural: 'résultats') %></p>
                  <div class="fr-select-group">
                    <label class="fr-sr-only fr-label" for="table-footer-select-7847">
                      Nombre de lignes par page
                    </label>
                    <div class="fr-messages-group" id="table-footer-select-7847-messages" aria-live="polite"></div>
                  </div>
                </div>
                <div class="fr-table__footer--middle">
                  <%== pagy_nav_custom(@pagy_validation) %>
                </div>
              </div>
            </div>
          <% end %>
          <dialog id="modal-acte" class="fr-modal" data-fr-concealing-backdrop="true">
            <%= turbo_frame_tag :acte, target: "_top" %>
          </dialog>
        </div>
      </div>
    <% end %>

    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12 fr-col-lg-12">
        <h2 class="fr-mt-2w">Actes clôturés [<%= @actes_cloture_all.count %>]</h2>
        <% if @actes_cloture.present? %>
          <div class="fr-table--lg fr-table fr-table--no-caption fr-mb-4w">
            <div class="fr-table__wrapper">
              <div class="fr-table__container">
                <div class="fr-table__content">
                  <table>
                    <caption>Actes clôturés</caption>
                    <thead>
                    <tr class="fr-cell--multiline">
                      <th scope="col">N°acte</th>
                      <th scope="col">Agent valideur</th>
                      <th scope="col">Nature</th>
                      <th scope="col">Montant</th>
                      <th scope="col">N°Chorus</th>
                      <th scope="col">
                        <% sort_date = "" %>
                        <% if params[:q_cloture] && params[:q_cloture][:s] == "date_cloture desc" %>
                          <% sort_date = "asc" %>
                        <% elsif params[:q_cloture] && params[:q_cloture][:s] == "date_cloture asc" %>
                          <% sort_date = "desc" %>
                        <% end %>
                        <div class="fr-cell--sort">
                          <span class="fr-cell__title">Date clôture</span>
                          <%= sort_link(@q_cloture, :date_cloture, '', default_order: :desc, class: 'fr-btn--sort fr-btn fr-btn--sm', aria: { sorting: sort_date }) %>
                        </div>
                      </th>
                      <th scope="col">Décision finale</th>
                      <th scope="col"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <% @actes_cloture.each_with_index do |acte, index| %>
                      <tr>
                        <td><p class="fr-badge <%= badge_class_for_type(acte.type_acte) %>"><%= acte.type_acte %></p>
                          n°<%= acte.numero_utilisateur %></td>
                        <td><p class="fr-tag"><%= acte.valideur %></p></td>
                        <td class="fr-cell--multiline"><%= acte.nature %></td>
                        <td><%= number_to_currency(acte.montant_ae, unit: "€", format: "%n %u") %></td>
                        <td><%= acte.numero_chorus %></td>
                        <td><%= l(acte.date_cloture, format: "%e/%m/%y") %></td>
                        <td class="fr-cell--multiline">
                          <p class="<%= badge_class_for_decision(acte.decision_finale) %>"><%= acte.decision_finale %></p>
                        </td>
                        <td>
                          <div class="fr-align-center">
                            <%= link_to ht2_acte_path(acte), class: 'fr-btn fr-btn--secondary fr-btn--sm', data: { turbo_frame: "_top" } do %>
                              Consulter
                            <% end %>
                            <% if ['DCB', 'CBR'].include?(@statut_user) %>
                              <%= link_to new_ht2_acte_path(id: acte.id), aria: { describedby: "tooltip-#{index}" }, class: "fr-btn fr-btn--sm fr-icon-file-add-line", data: { turbo_frame: "_top" } do %>
                                Dupliquer
                              <% end %>
                              <span class="fr-tooltip fr-placement" id="tooltip-<%= index %>" role="tooltip">Utiliser comme modèle pour un nouvel acte</span>
                            <% end %>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="fr-table__footer">
              <div class="fr-table__footer--start">
                <p class="fr-table__detail"><%= pluralize(@actes_cloture_all.count, 'résultat', plural: 'résultats') %></p>
                <div class="fr-select-group">
                  <label class="fr-sr-only fr-label" for="table-footer-select-7847">
                    Nombre de lignes par page
                  </label>
                  <div class="fr-messages-group" id="table-footer-select-7847-messages" aria-live="polite"></div>
                </div>
              </div>
              <div class="fr-table__footer--middle">
                <%== pagy_nav_custom(@pagy_cloture) %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>