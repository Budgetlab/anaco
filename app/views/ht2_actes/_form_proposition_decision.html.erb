<h2>Proposition de décision de contrôle</h2>
<div class="cwarning fr-mb-2w">Tous les champs comportant un astérisque (*) sont à remplir obligatoirement.</div>
<div data-controller="acte-form">
  <%= form_with model: @acte, data: { controller: 'nested-form', nested_form_wrapper_selector_value: '.nested-form-wrapper' } do |f| %>
    <%= hidden_field_tag :etape, 4 %>
    <% type_suspension = @acte.type_acte == 'avis' ? 'suspension' : 'interruption' %>
    <% action_suspension = @acte.type_acte == 'avis' ? "Suspendre l'acte" : "Interrompre l'acte" %>
    <% if @acte.etat == "en pré-instruction" %>
      <div class="fr-notice fr-notice--info fr-mb-2w">
        <div class="fr-container">
          <div class="fr-notice__body">
            <p>
              <span class="fr-notice__title">L'acte est en phase de pré-instruction.</span>
              <span class="fr-notice__desc">
                Vous pouvez compléter et enregistrer les informations suivantes. Vous pourrez ultérieurement passer l'acte en cours d'instruction ou clôturer définitivement l'acte à ce stade de pré-instruction.
                L'ajout de suspensions/interruptions n'est pas possible à ce stade et est possible uniquement pour les actes en cours d'instruction.</span>
            </p>
            <button onclick="const notice = this.parentNode.parentNode.parentNode; notice.parentNode.removeChild(notice)" title="Masquer le message" type="button" class="fr-btn--close fr-btn">Masquer
              le message
            </button>
          </div>
        </div>
      </div>
    <% else %>
      <!-- Suspension -->
      <div class="fr-callout fr-callout--brown-cafe-creme fr-mt-2w">
        <h3 class="fr-callout__title fr-capitalize fr-mb-2w fr-hidden"><%= type_suspension %></h3>
        <% if @acte.suspension_ouverte? %>
          <div class="fr-alert fr-alert--info">
            <p>Une <%= type_suspension %> est en cours.</p>
          </div>
          <div id="panelSuspension" class="fr-mt-4w">
            <%= f.fields_for :suspensions, @acte.suspension_ouverte do |sf| %>
              <%= render "form_suspension", f: sf, type_suspension: type_suspension, required: true %>
            <% end %>
          </div>
        <% else %>
          <% if @acte.suspensions.any? %>
            <div class="fr-table fr-table--no-caption">
              <div class="fr-table__wrapper">
                <div class="fr-table__container">
                  <div class="fr-table__content">
                    <table>
                      <caption> Suspensions/Interruptions</caption>
                      <thead>
                      <tr>
                        <th class="fr-capitalize"> <%= type_suspension %> </th>
                        <th> Date <%= type_suspension %></th>
                        <th> Date de reprise</th>
                        <th> Motif</th>
                        <th> Observations</th>
                        <th></th>
                      </tr>
                      </thead>
                      <tbody>
                      <% @acte.suspensions.order(created_at: :asc).each_with_index do |suspension, index| %>
                        <tr>
                          <td> n°<%= index + 1 %></td>
                          <td> <%= format_date_text(suspension.date_suspension) %> </td>
                          <td> <%= format_date_text(suspension.date_reprise) %></td>
                          <td> <%= suspension.motif %> </td>
                          <td class="fr-cell--multiline"> <%= format_value(suspension.observations) %></td>
                          <td>
                            <a href="<%= ht2_acte_suspension_modal_delete_path(@acte, suspension) %>" data-turbo-frame="modal" class="fr-btn fr-btn--secondary fr-btn--sm fr-icon-delete-bin-line fr-m-0" data-fr-opened="false" aria-controls="modal-acte">
                              Supprimer
                            </a>
                          </td>
                        </tr>
                      <% end %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          <% else %>
            <div class="fr-alert fr-alert--info">
              <p>
                <% if type_suspension == 'suspension' %>
                  Lorsque le contrôleur budgétaire doit rendre un avis préalable, il peut demander des informations complémentaires dans le délai de quinze jours. Dans ce cas, cette demande a pour effet de suspendre le délai d'examen jusqu'à la production de ces informations ou documents.
                  <% else %>
                  Lorsque le contrôleur budgétaire doit rendre un visa préalable, il peut demander des informations complémentaires dans le délai de quinze jours. Dans ce cas, un nouveau délai de quinze jours court à compter de la production des informations ou documents sollicités.
                <% end %>
              </p>
            </div>
          <% end %>
          <button type="button"
                  class="fr-btn fr-btn--secondary fr-btn--icon-left"
                  data-acte-form-target="toggleSuspensionButton"
                  data-action="click->acte-form#toggleSuspension">
            <%=action_suspension %>
          </button>
          <div id="panelSuspension" class="fr-mt-4w fr-hidden" >
            <%= f.fields_for :suspensions, @acte.suspensions.build do |sf| %>
              <%= render "form_suspension", f: sf, type_suspension: type_suspension, required: false %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12 fr-col-lg-6">
        <div class="fr-select-group">
          <label for="proposition_decision" class="fr-label">
            Proposition de décision de contrôle
            <% if @acte.etat == "en cours d'instruction" %><span id="asterix_proposition">*</span>
            <% end %>
          </label>
          <%= f.select :proposition_decision, options_for_select(@liste_decisions.map { |decision| [decision, decision] }, @acte.proposition_decision), { prompt: "- sélectionner -" }, { id: "proposition_decision", class: "fr-select", required: @acte.etat == "en cours d'instruction", data: (@acte.etat != 'en pré-instruction' ? { 'acte-form-target': 'decision', action: "change->acte-form#checkDecision" } : {}) } %>
        </div>
      </div>
      <div class="fr-col-12 fr-col-lg-6 fr-hidden" id="date_cloture_wrapper">
        <div class="fr-select-group">
          <label for="date_cloture" class="fr-label">Date de clôture</label>
          <%= f.text_field :date_cloture, class: "fr-select", data: { controller: "flatpickr", flatpickr_default_date: format_date(@acte.date_cloture), flatpickr_min_date: format_date(@acte.date_chorus), action: "input->acte-form#clotureSkipValidation" }, value: format_date(@acte.date_cloture), id: "date_cloture", placeholder: "- sélectionner -" %>
          <p class="fr-message fr-message--info fr-text--small">Renseigner une date pour clôturer l'acte directement à
            cette étape sans soumettre à validation.</p>
        </div>
      </div>
    </div>
    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12 fr-col-lg-12">
        <div class="fr-input-group">
          <label for="commentaire_proposition_decision" class="fr-label">Commentaire interne sur la proposition de
            décision de contrôle</label>
          <%= f.text_area :commentaire_proposition_decision, class: 'fr-input', rows: 6 %>
        </div>

        <div class="fr-input-group">
          <label for="observations" class="fr-label">Propositions d’observations à l’ordonnateur</label>
          <%= f.text_area :observations, class: 'fr-input', rows: 6 %>
        </div>
        <div data-controller="multi-select">
          <div class="fr-select-group">
            <label for="type_observations" class="fr-label">Type d'observations
              <span class="fr-hint-text">Plusieurs choix possibles</span></label>
            <%= select_tag "type_observations", options_for_select([["- sélectionner -", ""]] + @liste_types_observations.map { |type| [type, type] }),
                           id: "type_observations_select", class: "fr-select", data: { action: "change->multi-select#add", multi_select_target: "select" } %>
          </div>

          <!-- Conteneur pour afficher les tags -->
          <ul id="selected_observations" class="fr-tags-group" data-multi-select-target="container">
            <% @acte.type_observations&.each do |observation| %>
              <li data-action="click->multi-select#remove" data-value="<%= observation %>">
                <button class="fr-tag fr-tag--dismiss" type="button" aria-label="Retirer <%= observation %>">
                  <%= observation %>
                </button>
              </li>
            <% end %>
          </ul>

          <!-- Champ caché pour stocker les valeurs sélectionnées -->
          <%= f.hidden_field :type_observations, value: @acte.type_observations&.join(","), id: "hidden_type_observations", data: { multi_select_target: "hidden" } %>
        </div>
      </div>
    </div>

    <%= f.hidden_field :etat, value: @acte.etat, data: { acte_form_target: "submitAction" } %>

    <%# --- Submit “Suspendre” visible seulement en mode suspension --- %>
    <div class="fr-grid-row fr-grid-row--gutters <%= @acte.etat == "suspendu" ? "" : "fr-hidden" %>" id="suspension_submit_wrapper">
      <div class="fr-col-12 fr-col-lg-12">
        <div class="fr-checkbox-group fr-mb-2w">
          <%= check_box_tag :submit_suspension, "à suspendre", id: "suspendre", data: { action: "change->acte-form#suspendSkipValidation" } %>
          <label class="fr-label" for="suspendre">Soumettre cette<%= type_suspension %> à validation.</label>
        </div>
      </div>
      <div class="fr-col-12 fr-col-lg-12 fr-my-2w">
        <ul class="fr-btns-group fr-btns-group--icon-left fr-btns-group--inline fr-btns-group--right">
          <li>
            <%= button_tag type: 'submit',
                           id: "suspension_submit",
                           class: 'fr-btn' do %>
              <%=action_suspension %>
            <% end %>
          </li>
        </ul>
      </div>
    </div>

    <%# --- Autres boutons (doivent être masqués en mode suspension) --- %>
    <div class="fr-grid-row fr-grid-row--gutters" id="otherButtons">
      <div class="fr-col-12 fr-col-lg-12 fr-my-2w">
        <ul class="fr-btns-group fr-btns-group--icon-left fr-btns-group--inline fr-btns-group--right">

          <% if @acte.etat == "en pré-instruction" %>
            <li>
              <%= f.submit "Enregistrer et quitter", class: 'fr-btn' %>
            </li>
          <% elsif @acte.etat == "en cours d'instruction" %>
            <li id="save_button">
              <%= f.submit "Enregistrer et quitter", class: 'fr-btn fr-btn--secondary', data: { action: "click->acte-form#removeRequiredAndSubmit" } %>
            </li>
            <li id="validation_button">
              <%= button_tag type: 'submit',
                             class: 'fr-btn fr-icon-checkbox-line fr-btn--icon-left',
                             data: { action: "click->acte-form#setValidation", acte_form_target: "submitButton" } do %>
                Enregister et soumettre à validation
              <% end %>
            </li>
            <li id="cloture_button" class="fr-hidden">
              <%= f.submit "Clôturer l'acte", class: 'fr-btn', data: { action: "click->acte-form#confirmCloture" } %>
            </li>
          <% end %>
        </ul>
      </div>
    </div>

  <% end %>
</div>

<dialog id="modal-acte" class="fr-modal" aria-labelledby="modal-acte-title" data-fr-concealing-backdrop="true">
  <%= turbo_frame_tag :modal %>
</dialog>