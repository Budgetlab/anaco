<% content_for :title do %>Historique actes HT2 | ANACO
<% end %>
<div class="fr-container">
  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12 fr-col-lg-12">
      <h1 class="fr-mt-6w title-btn">
        Historique des actes HT2
      </h1>


      <div class="fr-table--lg fr-table fr-table--no-caption fr-mb-4w">
        <div class="fr-table__header">
          <p class="fr-table__detail"></p>
          <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-md fr-btns-group--icon-left">
            <li>
              <button class="fr-btn fr-icon-filter-line fr-btn--icon-left " aria-controls="filtres" aria-expanded="false">Filtrer
                les
                résultats
              </button>
            </li>
            <li>
              <button class="fr-btn fr-icon-download-line fr-btn--icon-left fr-btn--secondary">
                <%= link_to historique_ht2_path(format: :xlsx) do %>
                  Télécharger les actes
                <% end %>
              </button>
            </li>
          </ul>
        </div>
        <div class="fr-collapse fr-collapse--grey fr-px-2w" id="filtres" data-controller="request">
          <div class="fr-h4 fr-my-2w">Filtrer les résultats</div>
          <%= search_form_for @q, url: historique_ht2_path, data: { 'request-target': 'form', turbo_frame: 'table', turbo_action: 'advance' } do |f| %>
            <div class="fr-grid-row fr-grid-row--gutters">
              <div class="fr-col-12 fr-mb-1w">
                <label class="fr-label fr-text--bold">Rechercher</label>
                <%= f.search_field :numero_formate_or_numero_chorus_or_centre_financier_code_cont, class: "fr-input", placeholder: 'Rechercher un acte par n°acte, n°Chorus, centre financier', oninput: 'this.form.requestSubmit()' %>
              </div>
            </div>
            <div class="fr-grid-row fr-grid-row--gutters">
              <div class="fr-col-3">
                <%= render_tag_group "Type d'acte", :type_acte_in, ["avis", "visa", 'TF'] %>
              </div>
              <div class="fr-col-3">
                <%= render_tag_group "Exercice", :annee_in, (2025..Date.today.year).to_a.map(&:to_s) %>
              </div>
              <div class="fr-col-3">
                <%= render_select_group("Nature", :nature_in, @liste_natures) %>
              </div>
              <% if @statut_user == 'admin' %>
                <div class="fr-col-3">
                  <%= render_select_group("Contrôleur", :user_nom_in, User.where(statut: ['DCB', 'CBR']).order(nom: :asc).map { |p| p.nom }) %>
                </div>
              <% end %>
            </div>
            <div class="fr-grid-row fr-grid-row--gutters">
              <div class="fr-col-12">
                <%= render_tag_group 'Statut', :etat_in, ["en pré-instruction", "en cours d'instruction", "en attente de validation", "en attente de validation Chorus", 'suspendu', 'clôturé', 'clôturé après pré-instruction'] %>
              </div>
            </div>
          <% end %>
        </div>

        <%= turbo_frame_tag :table, data: { turbo_action: 'advance' } do %>
          <div class="fr-table__wrapper">
            <div class="fr-table__container">
              <div class="fr-table__content">
                <table>
                  <caption>Actes HT2</caption>
                  <thead>
                  <tr class="fr-cell--multiline">
                    <% if @statut_user == 'admin' %>
                      <th class="fr-cell--fixed" scope="col">Contrôleur</th>
                    <% end %>
                    <th scope="col">N°acte</th>
                    <th scope="col">
                      <% sort_date = "" %>
                      <% if params[:q] && params[:q][:s] == "updated_at desc" %>
                        <% sort_date = "asc" %>
                      <% elsif params[:q] && params[:q][:s] == "updated_at asc" %>
                        <% sort_date = "desc" %>
                      <% end %>
                      <div class="fr-cell--sort">
                        <span class="fr-cell__title">Actualisé le</span>
                        <%= sort_link(@q, :updated_at, '', default_order: :desc, class: 'fr-btn--sort fr-btn fr-btn--sm', aria: { sorting: sort_date }) %>
                      </div>
                    </th>
                    <th scope="col">Centre financier</th>
                    <th scope="col">Nature</th>
                    <th scope="col">Montant</th>
                    <th scope="col">N°Chorus</th>
                    <th scope="col">Statut</th>
                    <th scope="col"></th>
                  </tr>
                  </thead>
                  <tbody>
                  <% @actes.each_with_index do |acte, index| %>
                    <tr class="fr-cell--multiline">
                      <% if @statut_user == 'admin' %>
                        <td><%= acte.user.nom %></td>
                      <% end %>
                      <td>
                        <p class="fr-badge <%= badge_class_for_type(acte.type_acte) %>"><%= acte.type_acte %></p>
                        n°<%= acte.numero_formate %></td>
                      <td><%= l(acte.created_at, format: "%e/%m/%y") %></td>
                      <td><%= acte.centre_financier_code %></td>
                      <td class="fr-cell--multiline"><%= acte.nature %></td>
                      <td><%= number_to_currency(acte.montant_ae, unit: "€", format: "%n %u") %></td>
                      <td><%= acte.numero_chorus %></td>

                      <td class="fr-cell--multiline">
                        <p class="<%= badge_class_for_etat_actes(acte.etat) %>"><%= acte.etat %></p>
                      </td>
                      <td>
                        <div class="fr-align-center">
                          <%= link_to ht2_acte_path(acte), class: 'fr-btn fr-btn--secondary fr-btn--sm', data: { turbo_frame: "_top" } do %>
                            Consulter
                          <% end %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="fr-table__footer">
            <div class="fr-table__footer--start">
              <p class="fr-table__detail"><%= pluralize(@actes_all.count, 'résultat', plural: 'résultats') %></p>
              <div class="fr-select-group">
                <label class="fr-sr-only fr-label" for="table-footer-select-7847">
                  Nombre de lignes par page
                </label>
                <div class="fr-messages-group" id="table-footer-select-7847-messages" aria-live="polite"></div>
              </div>
            </div>
            <div class="fr-table__footer--middle">
              <%== pagy_nav_custom(@pagy) %>
            </div>
          </div>
        <% end %>
      </div>


    </div>
  </div>
</div>